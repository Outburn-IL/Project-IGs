<div id="intro" dir="rtl" markdown="1">

## הקדמה

ממשק התחייבויות הינו תהליך דיגיטלי המאפשר העברת בקשה להתחייבות מבית החולים לקופה עבורתור שקבע מטופל לשירות אמבולטורי מסויים, והחזרת מענה לאותה בקשה מטעם הקופה תוך עדכון המטופל לאורך התהליך.

הממשק כולל מספר תהליכים, בהם: בדיקת קיום התחייבות לשירות במועד מסויים |  שליחת בקשה להפקת התחייבות לתור עתידי | בחינת סטאטוס בקשה שכבר נשלחה אך עדיין לא התקבל עבורה מענה סופי.
התהליך מוגדר תוך שימוש בסטנדרט FHIR, וזאת באופן גנרי אשר יתאים ככל האפשר ליישום בכל ארגוני הבריאות בישראל.

מסמך זה הינו מדריך למיישם (IG - Implementation Guide) שנועד לסייע במימוש הפרוייקט באופן גנרי ופשוט, ולשמש ארגוני בריאות נוספים אשר ירצו בעתיד להצטרף לפרוייקט. 
המסמך כולל הנחיות טכניות עבור מיישמים, גם של ה- Client וגם של ה- Server, כך שכל צד יבין את דרישות הפרוייקט והתהליכים בהם הוא צריך לתמוך. לצד זאת מתואר גם הצד העסקי של התחייבויות באופן מתומצת - על בסיס ה- use-cases על פיהם הוגדר המדריך. 

בנוסף למדריך זה, קיים גם מסמך אפיון של התהליך העסקי ומידול הפתרון, בו הדגש הינו עסקי, ופחות טכני.
[קישור](https://www.fhir-il-community.org/%D7%A4%D7%A8%D7%95%D7%99%D7%A7%D7%98%D7%99-fhir/%D7%9E%D7%9E%D7%A9%D7%A7-%D7%93%D7%99%D7%92%D7%99%D7%98%D7%9C%D7%99-%D7%9C%D7%94%D7%AA%D7%97%D7%99%D7%99%D7%91%D7%95%D7%AA) לעמוד הפרוייקט באתר FHIR IL.

[קישור](https://www.fhir-il-community.org/_files/ugd/3ca9ed_e97a5e6fca58498b94759d8f28a3fdd5.pdf) למסמך האפיון העסקי באתר של FHIR IL.


## סקירת פרוייקט


להלן שני תרשימים עסקיים המתייחסים לשלושת תהליכי ממשק התחייבויות.

### תרשים עסקי - בדיקת סטאטוס התחייבות
בדיקת הסטאטוס רלוונטית הן כשלב מקדים לבקשה להפקת התחייבות, והן לבדיקת סטאטוס התחייבות כאשר המטופל מגיע פיזית לביה"ח.

![תרשים בדיקת סטאטוס התחייבות מבית החולים לקופה, במסגרת ממשק התחייבויות](./1.png)

בדיקת סטאטוס התחייבות מתבצעת על ידי ביה"ח, אשר יוזם שליחת בקשה לקופה.
הקופה מחזירה לבית החולים מענה הכולל מידע על קיום או אי קיום התחייבות עבור המטופל, לקודי השירות המבוקשים בתאריך המבוקש.


### תרשים עסקי – בקשה להפקת התחייבות


![תרשים בקשה להפקת התחייבות מבית החולים לקופה, במסגרת ממשק התחייבויות](./2.png)

תהליך בקשה להפקת התחייבות כולל מספר תהליכים:
1)	שליחת בקשה להפקת התחייבות, ביוזמת בית החולים. הקופה מקבלת את הבקשה ומחזירה מענה.
אם התקבלה החלטה סופית – הקופה תחזיר אישור עם או בלי מספר התחייבות, או סירוב לבקשה.
אם המענה אינו סופי, או שהתקבל אישור ללא מספר התחייבות:
2)	ביה"ח יבצע דגימה חוזרת של סטאטוס התשובה.
הבחינה תתבצע בהפרשים של X ימים (על פי החלטה בין שני הארגונים), החל מהבקשה להפקת ההתחייבות ועד לקבלת מענה סופי.

### אופן המימוש

מדריך יישום זה (ImplementationGuide) מתייחס לממשק התחייבויות דיגיטלי בין בית חולים לקופה וכולל מספר תרחישים אפשריים, החל מבדיקת סטאטוס התחייבות ועד לבקשה של ביה"ח להפקת התחייבות וקבלת אישור/סירוב מהקופה.
כל הממשק נעשה ללא התערבות נדרשת מצד המטופל*. 
התהליך נקרא Tofes-17, ובקצרה t17.

\* הקופה מיידעת את המטופל בשלבי התהליך, על פי המדיניות הפנימית.


<ins>**שלבי התהליך מצד ה- Client**

<ins>תהליך בדיקת הסטאטוס</ins> נעשה בנקודת זמן מסויימת, בודדת, בה ביה"ח בודק מול הקופה האם קיימת או לא התחייבות עבור שירותים מסויימים בתאריך מסוים, והקופה משיבה בהתאם.

<ins>תהליך בקשה להפקת התחייבות</ins> הינו תהליך עם אפשרות למספר שלבים עד לקבלת מענה סופי מהקופה להפקה או סירוב של התחייבות למטופל.

<ins>להלן שלבי התהליך:</ins><br>
נקודת ההתחלה הינה קביעת תור בבית החולים בהתאם להמלצת המטפל. ברגע זה נוצרת בקשה להפקת התחייבות הכוללת מספר resources:
מטופל* – הפרטים החיוניים לזיהוי מטופל / תור – פרטי התור שנקבע (תאריך, מטופל ומטפל) / מיקום – פרטי ביה"ח והמרפאה או המחלקה / מסמך – כולל את ההמלצה המפורשת של המטפל לזימון חוזר / הבקשה – מזהה הבקשה, מטופל ומטפל (במידה והמידע קיים), קודי השירות הרלוונטיים וקשרים ל- resources האחרים.
ביחד מתקבלת תמונה שלמה של כל המידע הרלוונטי לבחינת הבקשה להפקת התחייבות ע"י הקופה.

\* מטופל – ישנן שתי אפשרויות לזיהוי מטופל, ראו סעיף GET Patient

<br><br>
להלן ריכוז ה- resources היכולים לשמש בשליחת ה- request, כולל שם ה- resource ושם הפרופיל בהתאמה:

| **סוג המידע** | **שם ה- resource** | **שם הפרופיל** |
|:---:|:---:|:---:|
|    <br>פרטי הבקשה    |    <br>CoverageEligibilityRequest    |    <br>t17-request    |
|    <br>פרטי המטופל    |    <br>Patient    |    <br>* IL-Core Patient    |
|    <br>פרטי התור שנקבע    |    <br>Appointment    |    <br>t17-booked-appointment    |
|    <br>פרטי המיקום בו יתקיים התור    |    <br>Location    |    <br>t17-requested-location    |
|    <br>מסמך סיכום ביקור הכולל המלצה לביקור חוזר    |    <br>DocumentReference    |    <br>t17-visit-summary    |
|    <br>מארז הישויות לשליחת הבקשה     |    <br>Bundle    |    <br>t17-bundle-req    |

\* פרופיל מטופל הוגדר ע"י IL Core. הגדרות הפרופיל תואמות את צרכי הפרוייקט ולא נדרשו התאמות. יהיה בשימוש רק במידה וה- Client לא ביצע 

<br><br>
<ins>**שלבי התהליך מצד ה- Server**</ins>
עם קליטת הבקשה בקופה, מוחזר מענה לביה"ח, כאשר תכולתו מותנית בסוג הבקשה:
<ins>במצב של בדיקת סטאטוס התחייבות</ins>, המענה יהיה אחת משתי האפשרויות:
- ההתחייבות קיימת – יוחזרו שני resources: פרטי המענה + פרטי ההתחייבות
- ההתחייבות לא קיימת – יוחזר resource של פרטי המענה בלבד.
במצב של בקשה להפקת התחייבות, המענה יהיה אחת מהאפשרויות הבאות:
- אישור לבקשה להפקת ההתחייבות, כולל מספר התחייבות - יוחזרו שלושה resources לביה"ח: פרטי המענה + פרטי ההתחייבות + מסמך ההתחייבות.
-  סירוב, כשל, בחינה, או אישור ללא מספר התחייבות – יוחזרו לביה"ח רק פרטי המענה.

(במקרה של אישור ללא מספר התחייבות - המספר ישלח במועד מאוחר יותר על פי הסכמה בין הצדדים).

<br>
להלן ריכוז ה- resources היכולים לשמש בהחזרת ה- response, כולל שם ה- resource ושם הפרופיל בהתאמה:

| **סוג המידע** | **שם ה- resource** | **שם הפרופיל** |
|:---:|:---:|:---:|
|    <br>פרטי המענה     |    <br>CoverageEligibilityResponse    |    <br>t17-response    |
|    <br>פרטי ההתחייבות    |    <br>Coverage    |    <br>t17-obligation    |
|    <br>מסמך ההתחייבות    |    <br>DocumentReference    |    <br>t17-obligation-doc    |
|    <br>מארז הישויות להחזרת המענה לבקשה    |    <br>Bundle    |    <br>t17-bundle-res    |

### אופן זיהוי המטופל
יש שתי אפשרויות להעברת פרטי המטופל לצורך זיהויו בקופה:
1.	העברת Patient Resource כחלק מה- Bundle של הבקשה. במקרה זה הבקשה תכלול את כל פרטי המטופל הנחוצים לצורך הזיהוי שלו במערכות הקופה.
2.	ביצוע שליפה של המטופל משרת הקופה באמצעות GET Patient, סעיף GET Patient.

במידה וה- Client ביצע שליפת מטופלים באמצעות GET Patient אין צורך לכלול את המטופל כחלק ממארז ה- request, אלא להגדיר ב- reference למטופל את הכתובת היחסית שלו ב- Server (על פי התבנית: Patient/\<logical id\>).

### Data Model
#### בקשה להתחייבות ומענה מיידי
ה- Client, ביה"ח, שולח לקופה בקשה לבדיקת סטאטוס/להפקת התחייבות באופן הבא:

**POST [server]/CoverageEligibilityRequest/$submit**

זוהי בקשה לבדיקה/הפקת ההתחייבות, באמצעות submit$ של CoverageEligibilityRequest.

מבחינת תקן FHIR ניתן להפעיל את פעולת submit$ באמצעות ריסורס CoverageEligibilityRequest בודד, או באמצעות Bundle המכיל אותו וכן ריסורסים נוספים הרלוונטיים לבקשה. לצורך האחידות הוחלט כי המימוש במסגרת פרויקט זה יהיה תמיד באמצעות Bundle, גם אם לא מועברים רוסורסים נוספים ל-Request. כלומר, נשלח Bundle המכיל את הריסורס הייעודי לבקשה, ביחד עם ריסורסים נוספים (על פי מידת הרלוונטיות) הקשורים אליו  באמצעות reference.<br>
שליחת הבקשה הינה סוג של "הזנקת" תהליך, כך שהבקשה והריסורסים הנלווים נשלחים, ובאופן סינכרוני מוחזר מענה מה- Server, מהקופה. המענה יתכן אישור / סירוב / כשל / בבחינה.<br>
המענה מורכב ממספר וריאציות של ריסורסים, כתלות בתשובת הקופה לקיום התחייבות.
להלן תרשים התהליך, כולל כל הריסורסים הרלוונטיים, המייצג מצב של בקשה להפקת התחייבות וכתגובה מתקבל מענה של אישור, עם מספר ההתחייבות:

![תרשים Data Model](./3.png)

במצב של בדיקת סטאטוס התחייבות ישלח CoverageEligibilityRequest ויוחזר CoverageEligibilityResponse.
במידה וקיימת התחייבות, יוחזר גם Coverage.

#### דגימת סטאטוס של בקשה להפקת התחייבות
במקרה שביה"ח שלח בקשה להפקת התחייבות וקיבל מהקופה סטאטוס "בבחינה", לאחר X זמן (על פי החלטת הארגונים המעורבים) ביה"ח ידגום את הקופה, לבדיקה האם סטאטוס הבקשה התעדכן סופית (אישור/סירוב).

ה- Client, ביה"ח, דוגם את הקופה באופן הבא:

**GET [server]/CoverageEligibilityResponse/id**

ה- id של ה- CoverageEligibilityResponse ידוע ל- Client מהבקשה המקורית, לכן הדגימה על פי המזהה הלוגי.

במידה והסטאטוס התעדכן, ביה"ח בודק האם הבקשה אושרה או סורבה.
אם אושרה – ביה"ח בודק האם התקבל גם מספר ההתחייבות המאושרת, באלמנט הבא:  
CoverageEligibilityResponse.insurance.coverage.reference

במידה והתקבל מספר ההתחייבות, ביה"ח יתשאל את הקופה לקבלת ריסורס ההתחייבות + מסמך ההתחייבות עצמו: Coverage + DocumentReference.

**GET [server]/Coverage?_id=[resource_id]&_revinclude=DocumentReference:related**

ה- id של ה- Coverage כפי שהתקבל במענה העדכני מהקופה.
בתגובה ל- GET יתקבל Bundle מסוג searchset אשר יכיל את שני ה- resources המייצגים את ההתחייבות.

![תרשים תפיסת פתרון לדגימה חוזרת של מצב התחייבות](./4.png)

#### עדכון בקשה להפקת התחייבות
שימו לב, האירועים העסקיים שבגינם נדרש עדכון של הבקשה יוסכמו בין הצדדים ואינם באים לידי ביטוי במדריך זה.

במקרה של עדכון, ביה"ח שולח לקופה בקשה להפקת התחייבות חדשה.<br>
הבקשה החדשה מכילה קישור לבקשה המקורית להפקת ההתחייבות (הבקשה הקודמת אותה מעוניינים להחליף, למשל אשר התור שלה עודכן למועד אחר).

הקישור לבקשה המקורית נעשה על ידי האלמנט: CoverageEligibilityRequest.supportingInfo.

כיצד ניתן לזהות שמדובר בבקשה לעדכון בקשה להפקת התחייבות, ולא בקשה עצמאית חדשה?

* האיבר supportingInfo[n].information.type – קיים איבר אחד במערך עם ערך מסוג "CoverageEligibilityRequest", כלומר ניתן לזהות שהבקשה מקושרת לבקשה אחרת, אותה היא באה להחליף.

* האיבר status – ערך הסטאטוס הינו active ולא cancelled.

ניתן להיעזר גם בתרשים בסעיף Request - עץ החלטות

תגובת הקופה לבקשת ביה"ח החדשה, תיתכן אישור / סירוב / ממתינה, כפי שמתואר גם בתגובה לבקשה חדשה.

![תרשים עדכון | מבית החולים לקופה](./5.png)

#### ביטול בקשה להפקת התחייבות
במקרה של ביטול בקשה, למשל בעקבות ביטול תור, ביה"ח שולח לקופה בקשה מבוטלת, בדומה לאופן עדכון בקשה קודמת.<br>
הבקשה המבוטלת (החדשה) מכילה קישור לבקשה להפקת ההתחייבות המקורית (הבקשה הקודמת אותה מעוניינים להחליף בבקשה המבוטלת).

הקישור לבקשה המקורית נעשה על ידי האלמנט: CoverageEligibilityRequest.supportingInfo.

כיצד ניתן לזהות שמדובר בבקשה לביטול בקשת התחייבות, ולא בקשה חדשה או בקשה מעודכנת?

* האיבר status – ערך הסטאטוס הינו cancelled. זהו המצב היחיד בו יהיה ערך ביטול בבקשה להתחייבות.
* האיבר supportingInfo[n].information.type – קיים איבר אחד בלבד במערך, והערך שלו יהיה מסוג "CoverageEligibilityRequest", כלומר ניתן לזהות שהבקשה מקושרת לבקשה אחרת, אותה היא באה לבטל.

יש לשים לב – סטאטוס הביטול מוגדר על הבקשה החדשה שנשלחת, והיא מקושרת לבקשה המקורית אותה מעוניינים לבטל. 

תגובת הקופה לבקשת ביה"ח החדשה תהיה ללא קישור לריסורסים נוספים (ללא Coverage או DocumentReference), ובאלמנט של CoverageEligibilityResponse.disposition יהיה תיאור מילולי שייצג את ביצוע הביטול. 

\* שימו לב - במצב של מענה לביטול שהסתיים בהצלחה, CoverageEligibilityResponse.status יהיה "active" ולא "cancelled", וכן CoverageEligibilityResponse.outcome יהיה “complete” (המענה אינו מבוטל, אלא מגיב להודעת ביטול).

![תרשים ביטול תור | מבית החולים לקופה](./6.png)

#### מידע חובה לשמירה בבקשה להפקת התחייבות
ישנם שני מזהים אשר גם ה- Client וגם ה- Server צריכים לשמור:
1.	המזהה העסקי של הבקשה: CoverageEligibilityRequest.identifier
הסיבה לכך: נדרש למצב של עדכון או ביטול, במקרה כזה תישלח בקשה להתחייבות חדשה עם reference למזהה העסקי של הבקשה אותה מעוניינים להחליף/לבטל.

2.	המזהה הלוגי של המענה: CoverageEligibilityResponse.id
הסיבה לכך: נדרש למצב של דגימת מענה מביה"ח לקופה, כאשר התקבל מענה שאינו סופי (בהמתנה, אישור ללא מספר ההתחייבות).


</div>

